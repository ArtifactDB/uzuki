<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>uzuki: R lists to JSON, safely</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">uzuki
   </div>
   <div id="projectbrief">Recovering R lists faithfully from JSON</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">R lists to JSON, safely </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md__github_workspace_README"></a> <img src="https://github.com/LTLA/uzuki/actions/workflows/run-tests.yaml/badge.svg" alt="Unit tests" style="pointer-events: none;" class="inline"/> <img src="https://github.com/LTLA/uzuki/actions/workflows/doxygenate.yaml/badge.svg" alt="Documentation" style="pointer-events: none;" class="inline"/> <a href="https://codecov.io/gh/LTLA/uzuki"><img src="https://codecov.io/gh/LTLA/uzuki/branch/master/graph/badge.svg?token=J3dxS3MtT1" alt="codecov" style="pointer-events: none;" class="inline"/></a></p>
<h1>Overview</h1>
<p >The <b>uzuki</b> repository describes a format for safely serializing R lists into JSON. While most of this is handled by packages like <b>jsonlite</b>, there are some subtleties with respect to preserving type, e.g., factors, dates, integers versus doubles. Some mechanism is also required to handle multi-dimensional arrays, data frames, and external references to non-serializable objects. The C++ library implements a portable validator for this specification.</p>
<h1>Specification</h1>
<h2>Concepts</h2>
<p >The serialized JSON string should contain a single array or JSON object. The array/object may contain any number of nested arrays/objects, which in turn may contain any number of nested arrays/objects.</p>
<p >All non-list R objects are represented as a JSON object with a <code>type</code> key. The value of <code>type</code> should be a string that determines the structure of the rest of the object. This ensures that the type of the R object can be recovered from the JSON.</p>
<p >As R does not have any concept of scalars, neither does <b>uzuki</b>. All "scalars" are treated as atomic vectors of length 1.</p>
<p >List objects are represented as plain JSON arrays or objects - see below for more details. These are considered as "structural" elements and so they do not require a <code>type</code> string.</p>
<h2>Atomic vectors</h2>
<p >We expect a <code>values</code> array containing the contents of the atomic vector. For example, an integer vector of <code>1:4</code> is represented as:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">    &quot;values&quot;: [1, 2, 3, 4]</div>
<div class="line">}</div>
</div><!-- fragment --><p >This layout is supported for <code>type</code>s of <code>integer</code>, <code>string</code>, <code>number</code> and <code>boolean</code>, where the elements in <code>values</code> should be of the corresponding JSON type. (Integers should be integral values in the JSON numeric type.) Missing values are supported by using <code>null</code>.</p>
<p >Optionally, we may have a <code>names</code> array of the same length as the <code>values</code> array. This should contain strings with the names of each element. No <code>nulls</code> are allowed.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">    &quot;values&quot;: [1, 2, 3, 4],</div>
<div class="line">    &quot;names&quot;: [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><p >As in R, there is no concept of scalars; the closest supported analog is a length-1 vector in <code>values</code>.</p>
<h2>Atomic arrays</h2>
<p >We expect a <code>values</code> array containing the contents of the atomic array, and a <code>dimensions</code> array containing the length of each dimension as integers. The product of values in <code>dimensions</code> should be equal to the length of <code>values</code>.</p>
<p >In <code>values</code>, we assume that the first dimension is the fastest changing, then the second, then the third, and so on. For example, an integer matrix of</p>
<div class="fragment"><div class="line">1 6</div>
<div class="line">2 7</div>
<div class="line">3 8</div>
<div class="line">4 9</div>
<div class="line">5 0</div>
</div><!-- fragment --><p >would be represented as</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">    &quot;values&quot;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 0]</div>
<div class="line">    &quot;dimensions&quot;: [5, 2]</div>
<div class="line">}</div>
</div><!-- fragment --><p >This layout is supported for <code>type</code>s of <code>integer</code>, <code>string</code>, <code>number</code> and <code>boolean</code>, where the elements in <code>values</code> should be of the corresponding JSON type. (Integers should be integral values in the JSON numeric type.) Missing values are supported by using <code>null</code>.</p>
<p >Optionally, we may have a <code>names</code> array of the same length as <code>dimensions</code> array. This should contain arrays of strings with the names along each dimension, or <code>null</code> if the dimension is unnamed. Each array should be of length equal to the corresponding element of <code>dimensions</code>. No <code>nulls</code> are allowed within each string array.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">    &quot;values&quot;: [1, 2, 3, 4, 5, 6, 7, 8, 9, 0]</div>
<div class="line">    &quot;dimensions&quot;: [5, 2]</div>
<div class="line">    &quot;names&quot;: [[&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;], null]</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Factors</h2>
<p >For <code>factor</code> or <code>ordered</code> types, we require a <code>values</code> array containing the factor values as strings. We also expect an additional <code>levels</code> array of strings containing the factor levels in an appropriate order. <code>levels</code> must be unique and a superset of all entries in <code>values</code>, with one exception: <code>values</code> may contain <code>null</code> but <code>levels</code> may not.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;factor&quot;,</div>
<div class="line">    &quot;values&quot;: [&quot;aaron&quot;, &quot;mike&quot;, null],</div>
<div class="line">    &quot;levels&quot;: [&quot;aaron&quot;, &quot;mike&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Dates</h2>
<p >For the <code>date</code> type, we require a <code>values</code> array containing YYYY-MM-DD dates as strings. Missing values are allowed and are represented as <code>null</code>s.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;date&quot;,</div>
<div class="line">    &quot;values&quot;: [&quot;2021-02-31&quot;, &quot;2121-03-11&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Data frames</h2>
<p >For the <code>data.frame</code> type, we expect the following additional fields:</p>
<ul>
<li><code>rows</code>: an integer specifying the number of rows in the data frame.</li>
<li><code>columns</code>: a JSON object containing the named fields. Each element can be any of the supported types. Vectors, factors and dates should have length equal to <code>rows</code>, while the first dimension of any arrays should be equal to <code>rows.</code></li>
<li><code>names</code>: (optional) a string array of length equal to <code>rows</code>, containing the name of each row. <code>null</code> values are not allowed here.</li>
</ul>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;data.frame&quot;,</div>
<div class="line">    &quot;rows&quot;: 5</div>
<div class="line">    &quot;columns&quot;: {</div>
<div class="line">        &quot;stuff&quot;: {</div>
<div class="line">            &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">            &quot;values&quot;: [1,2,3,4,5]</div>
<div class="line">        },</div>
<div class="line">        &quot;foobar&quot;: {</div>
<div class="line">            &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">            &quot;dimensions&quot;: [5, 2],</div>
<div class="line">            &quot;values&quot;: [&quot;&quot;, &quot;&quot;, &quot;A&quot;, &quot;&quot;, &quot;&quot;, &quot;B&quot;, &quot;C&quot;, &quot;&quot;, &quot;&quot;, &quot;D&quot;]</div>
<div class="line">        }</div>
<div class="line">    },</div>
<div class="line">    &quot;names&quot;: [ &quot;v&quot;, &quot;w&quot;, &quot;x&quot;, &quot;y&quot;, &quot;z&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Nothing</h2>
<p >In some cases, it can be useful to set a placeholder "nothing" value inside the list. For example, this maps to a <code>NULL</code> element in R or a <code>None</code> value in Python. It is supported by specifying an object with <code>"type": "nothing"</code>, i.e.:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;nothing&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Other objects</h2>
<p >All other R objects are accommodated by setting <code>type</code> to <code>"other"</code>. This should be accompanied by an <code>index</code> integer that identifies this R object uniquely within the entire list. <code>index</code> should start at zero and be incremented whenever an unknown R object is encountered.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;type&quot;: &quot;other&quot;,</div>
<div class="line">    &quot;index&quot;: 0</div>
<div class="line">}</div>
</div><!-- fragment --><p >Each index is a reference to external metadata describing more complex objects. By indexing this external metadata, we can restore the object in its appropriate location in the R list. The exact mechanism by which this restoration occurs is implementation-defined.</p>
<h2>Lists</h2>
<p >Unnamed lists are represented as JSON arrays. For example, <code>list(1:4, LETTERS[1:2])</code> is represented as:</p>
<div class="fragment"><div class="line">[</div>
<div class="line">    {</div>
<div class="line">        &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">        &quot;values&quot;: [ 1, 2, 3, 4 ]</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">        &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">        &quot;values&quot;: [ &quot;A&quot;, &quot;B&quot; ]</div>
<div class="line">    }</div>
<div class="line">]</div>
</div><!-- fragment --><p >Named lists are represented as JSON objects where the keys are the names of the elements and the values are the elements themselves. Names are expected to be unique. For example, <code>list(X=1:4, Y=LETTERS[1:2])</code> is represented as:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;X&quot;: {</div>
<div class="line">        &quot;type&quot;: &quot;integer&quot;,</div>
<div class="line">        &quot;values&quot;: [ 1, 2, 3, 4 ]</div>
<div class="line">    },</div>
<div class="line">    &quot;Y&quot;: {</div>
<div class="line">        &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">        &quot;values&quot;: [ &quot;A&quot;, &quot;B&quot; ]</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1>Implementation</h1>
<h2>Quick start</h2>
<p >A reference implementation of the validator is provided as a header-only C++ library in <a href="include/uzuki"><code>include/uzuki</code></a>. This is useful for portable deployment in different frameworks like R, Python, etc. Once a JSON file is loaded in using the <a href="https://github.com/nlohmann/json"><code>nlohmann/json</code></a> library, we can check that it complies with the <b>uzuki</b> specification:</p>
<div class="fragment"><div class="line">#include &quot;uzuki/uzuki.hpp&quot;</div>
<div class="line"> </div>
<div class="line">auto contents = nlohmann::json::parse(json_str);</div>
<div class="line">uzuki::validate(contents);</div>
</div><!-- fragment --><p >This will raise an error if any violations of the specification are observed. If the expected number of "other" objects is known, we can check that there are no more references than expected:</p>
<div class="fragment"><div class="line">uzuki::validate(contents, num_references);</div>
</div><!-- fragment --><p >Advanced users can also use the <b>uzuki</b> parser to transform the JSON content into more convenient representations. This is achieved by calling <code>parse()</code> with custom provisioner and external reference classes. For example, <a href="tests/src/test_subclass.h"><code>tests/src/test_subclass.h</code></a> defines the <code>DefaultProvisioner</code> and <code>DefaultExternals</code> classes, which can be used to load the JSON contents into <code>std::vector</code>s for easier downstream operations.</p>
<div class="fragment"><div class="line">DefaultExternals ext(nexpected);</div>
<div class="line"><span class="keyword">auto</span> ptr = uzuki::parse&lt;DefaultProvisioner&gt;(contents, ext);</div>
</div><!-- fragment --><p >Also see the <a href="https://ltla.github.io/comservatory">reference documentation</a> for more details.</p>
<h2>Building projects</h2>
<p >If you're using CMake, you just need to add something like this to your <code>CMakeLists.txt</code>:</p>
<div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line"> </div>
<div class="line">FetchContent_Declare(</div>
<div class="line">  libscran</div>
<div class="line">  GIT_REPOSITORY https://github.com/LTLA/uzuki</div>
<div class="line">  GIT_TAG master # or any version of interest </div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">FetchContent_MakeAvailable(uzuki)</div>
</div><!-- fragment --><p >Then you can link to <b>uzuki</b> to make the headers available during compilation:</p>
<div class="fragment"><div class="line"># For executables:</div>
<div class="line">target_link_libraries(myexe uzuki)</div>
<div class="line"> </div>
<div class="line"># For libaries</div>
<div class="line">target_link_libraries(mylib INTERFACE uzuki)</div>
</div><!-- fragment --><h1>Links</h1>
<p >I can't remember where the name comes from, but it was probably from my habit of falling back to **iDOLM@ster** characters when I can't think of a better name. In this case, <a href="https://myanimelist.net/character/70883/Uzuki_Shimamura">Uzuki Shimamura</a>:</p>
<p ><img src="https://pa1.narvii.com/6088/154344d5baafcd9da3154511d868e8b3ee33f5a4_hq.gif" alt="Uzuki Shimamura" class="inline"/> </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
